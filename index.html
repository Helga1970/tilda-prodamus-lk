<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Регистрация на сайте</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Circe+Rounded:wght@400;700&display=swap');
    * { box-sizing: border-box; }

    body {
      font-family: 'Circe Rounded', sans-serif;
      background-color: #f4f4f4;
      min-height: 100vh;
      margin: 0;
      display: grid;
      place-items: center;
      padding: 20px;
    }

    .registration-container {
      background-color: #ffffff;
      padding: 32px 28px;
      border-radius: 0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: min(94vw, 600px);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 80vh;
    }

    h1 {
      text-align: center;
      color: #333;
      margin: 0 0 24px;
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 700;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 14px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 15px;
    }

    .password-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-container input {
      flex: 1;
      padding-right: 96px;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #999;
      padding: 4px 6px;
    }

    button[type="submit"] {
      width: 100%;
      padding: 15px;
      background-color: #fb4d35;
      color: #fff;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }

    button[type="submit"]:hover {
      background-color: #e5462e;
    }

    #message {
      margin-top: 18px;
      font-weight: 700;
      line-height: 1.5;
      text-align: center;
    }

    .form-links {
      margin-top: 18px;
      font-size: 14px;
      text-align: center;
    }

    .form-links div { margin-bottom: 6px; }

    .form-links a {
      color: #fb4d35;
      text-decoration: none;
    }

    .form-links a:hover { text-decoration: underline; }

    .captcha-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    #captcha-question {
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    /* Адаптивность */
    @media (max-width: 480px) {
      .registration-container {
        padding: 24px 18px;
        min-height: 90vh;
      }

      button[type="submit"] {
        padding: 12px;
        font-size: 15px;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"] {
        padding: 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="registration-container">
    <h1 id="main-title">Регистрация на сайте</h1>

    <!-- форма регистрации -->
    <form id="registrationForm">
      <div class="form-group">
        <label for="name">Имя:</label>
        <input type="text" id="name" name="name" required />
      </div>

      <div class="form-group">
        <label for="email">E-mail:</label>
        <input type="email" id="email" name="email" required />
      </div>

      <div class="form-group">
        <label for="password">Пароль:</label>
        <div class="password-container">
          <input type="password" id="password" name="password" placeholder="Минимум 8 символов, буквы и цифры" required />
          <button type="button" class="password-toggle" id="password-toggle-btn" onclick="togglePassword()">Показать</button>
        </div>
      </div>

      <div class="form-group captcha-group">
        <label for="captcha-input" id="captcha-question">Капча</label>
        <input type="text" id="captcha-input" name="captcha" required />
      </div>

      <button type="submit">Зарегистрироваться</button>
    </form>

    <!-- форма восстановления -->
    <form id="resetPasswordForm" style="display: none;">
      <div class="form-group">
        <label for="reset-email">E-mail:</label>
        <input type="email" id="reset-email" name="email" required />
      </div>
      <button type="submit">Восстановить пароль</button>
    </form>

    <p id="message"></p>

    <div class="form-links">
      <div id="already-registered-container">
        Уже зарегистрированы?
        <a href="https://pro-culinaria-lk.proculinaria-book.ru">Войти</a>
      </div>

      <!-- Ссылка "Восстановить пароль" показывается только на форме регистрации -->
      <div id="reset-link-container">
        <a href="#" onclick="showForm('reset-password')">Восстановить пароль</a>
      </div>

      <div id="back-to-form-container" style="display: none;">
        <a href="#" onclick="showForm('register')">Вернуться к регистрации</a>
      </div>

      <div id="back-to-login-container" style="display: none;">
        <a href="https://pro-culinaria-lk.proculinaria-book.ru">Вернуться ко входу</a>
      </div>
    </div>
  </div>

  <script>
    let captchaAnswer;

    function generateCaptcha() {
      const num1 = Math.floor(Math.random() * 10) + 1;
      const num2 = Math.floor(Math.random() * 10) + 1;
      document.getElementById('captcha-question').textContent = `Сколько будет ${num1} + ${num2}?`;
      captchaAnswer = num1 + num2;
      document.getElementById('captcha-input').value = '';
    }

    function togglePassword() {
      const passwordField = document.getElementById('password');
      const passwordToggleButton = document.getElementById('password-toggle-btn');
      const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordField.setAttribute('type', type);
      passwordToggleButton.textContent = (type === 'password') ? 'Показать' : 'Скрыть';
    }

    function isValidPassword(password) {
      const minLength = 8;
      const hasLetters = /[a-zA-Z]/.test(password);
      const hasNumbers = /[0-9]/.test(password);
      return password.length >= minLength && hasLetters && hasNumbers;
    }

    function showForm(formType) {
      document.getElementById('registrationForm').style.display = 'none';
      document.getElementById('resetPasswordForm').style.display = 'none';
      document.getElementById('message').textContent = '';

      document.getElementById('already-registered-container').style.display = 'block';
      document.getElementById('back-to-form-container').style.display = 'none';
      document.getElementById('back-to-login-container').style.display = 'none';

      if (formType === 'register') {
        document.getElementById('registrationForm').style.display = 'block';
        document.getElementById('main-title').textContent = 'Регистрация на сайте';
        document.getElementById('reset-link-container').style.display = 'block'; // показываем только на регистрации
        generateCaptcha();
      } else if (formType === 'reset-password') {
        document.getElementById('resetPasswordForm').style.display = 'block';
        document.getElementById('main-title').textContent = 'Восстановление пароля';
        document.getElementById('reset-link-container').style.display = 'none'; // скрываем на форме восстановления
        document.getElementById('back-to-form-container').style.display = 'block';
      }
    }

    document.getElementById('registrationForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const captchaInput = document.getElementById('captcha-input').value;
      const messageElement = document.getElementById('message');
      const formElement = document.getElementById('registrationForm');

      if (parseInt(captchaInput, 10) !== captchaAnswer) {
        messageElement.textContent = 'Неверный ответ на капчу. Попробуйте еще раз.';
        messageElement.style.color = 'red';
        generateCaptcha();
        return;
      }

      if (!isValidPassword(password)) {
        messageElement.textContent = 'Пароль должен содержать минимум 8 символов, включая буквы и цифры.';
        messageElement.style.color = 'red';
        return;
      }

      messageElement.textContent = 'Обработка...';
      messageElement.style.color = '#333';

      try {
        const response = await fetch('https://pro-culinaria-lk.proculinaria-book.ru/.netlify/functions/register-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Server returned error: ${response.status} - ${response.statusText}`);
        }

        formElement.style.display = 'none';
        document.getElementById('main-title').style.display = 'none';
        messageElement.style.color = 'green';
        messageElement.innerHTML = 'Регистрация прошла успешно!<br>Проверьте свою почту для входа.<br>Если письма нет во входящих, проверьте папку <strong>Спам</strong>.';

        document.getElementById('back-to-login-container').style.display = 'block';
        document.getElementById('reset-link-container').style.display = 'none';
      } catch (e) {
        console.error('Ошибка:', e);
        messageElement.textContent = e.message || 'Произошла ошибка при регистрации. Пожалуйста, попробуйте позже.';
        messageElement.style.color = 'red';
        generateCaptcha();
      }
    });

    document.getElementById('resetPasswordForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const email = document.getElementById('reset-email').value.trim();
      const messageElement = document.getElementById('message');
      const formElement = document.getElementById('resetPasswordForm');

      messageElement.textContent = 'Обработка...';
      messageElement.style.color = '#333';

      try {
        const response = await fetch('https://pro-culinaria-lk.proculinaria-book.ru/.netlify/functions/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const result = await response.json().catch(() => ({}));

        if (!response.ok) {
          throw new Error(result.error || `Server returned error: ${response.status} - ${response.statusText}`);
        }

        formElement.style.display = 'none';
        document.getElementById('main-title').textContent = 'Восстановление пароля';
        messageElement.style.color = 'green';
        messageElement.innerHTML = result.message || 'На ваш e-mail отправлены инструкции по восстановлению.';

        document.getElementById('back-to-login-container').style.display = 'block';
        document.getElementById('back-to-form-container').style.display = 'block';
      } catch (e) {
        console.error('Ошибка:', e);
        messageElement.textContent = e.message || 'Произошла ошибка при восстановлении пароля. Пожалуйста, попробуйте позже.';
        messageElement.style.color = 'red';
      }
    });

    generateCaptcha();
  </script>
</body>
</html>
